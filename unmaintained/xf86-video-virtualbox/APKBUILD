# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=xf86-video-virtualbox
pkgdesc="Xorg Virtual box video driver"
pkgver=5.0.12
_ver=${pkgver/_rc/_RC}
_xver="118"
pkgrel=0
arch="all"
url='http://virtualbox.org'
license="GPL custom"
makedepends="linux-grsec-dev yasm kbuild zlib-dev
	linux-headers python libx11-dev libelf-dev"
source="http://download.virtualbox.org/virtualbox/$_ver/VirtualBox-$_ver.tar.bz2
	https://github.com/megastep/makeself/archive/release-2.2.0.tar.gz
	LocalConfig.kmk
	no-glibc.patch
	dladdr1.patch
	"
#	uclibc-spawn.patch

_builddir="$srcdir/VirtualBox-${_ver}"

prepare() {
	cd "$_builddir"
	local i
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	## the kmk_sed they ship and use is linked to glibc...
	#sed -i -e 's:KBUILD_SED=.*:KBUILD_SED="busybox sed":' configure
	#rm -r kBuild/bin tools
	cp "$srcdir"/LocalConfig.kmk .
}

build() {
	cd "$_builddir"
	cp "$srcdir/LocalConfig.kmk" .
	ln -s "$srcdir/makeself-release-2.2.0/makeself.sh" "$srcdir/makeself-release-2.2.0/makeself"
	PATH=$PATH:$srcdir/makeself-release-2.2.0 ./configure --only-additions || return 1
	. ./env.sh
	for i in Runtime Additions/common/VBoxGuestLib \
			Additions/x11/x11stubs Additions/x11/vboxvideo; do
		cd "$_builddir"/src/VBox/$i
		kmk TOOL_YASM_AS=yasm || return 1
	done
}

package() {
	cd "$_builddir"/out/linux.*/release/bin/additions
	install -Dm755 vboxvideo_drv_"$_xver".so \
		"$pkgdir"/usr/lib/xorg/modules/drivers/vboxvideo_drv.so
}

md5sums="5912835882ef547e0559c7e73bc85828  VirtualBox-5.0.12.tar.bz2
8075530b2ad0a2fbd4bffa80a96eb2ea  release-2.2.0.tar.gz
eedb57172f97829c2ad53fdb970a1c68  LocalConfig.kmk
495991bcb6e4020eddcc4550c9f7484d  no-glibc.patch
a04cc25f73b25c7f85b347fec5120438  dladdr1.patch"
sha256sums="de0362b1d404d1ca0298db1984acb6f0f1c6210313aeb744fea345ad9201e86e  VirtualBox-5.0.12.tar.bz2
9c9d003e097d9c198433a05926e64d9b7cd330c7f10cb4e6048877d0a87de341  release-2.2.0.tar.gz
5ec9b53a113af1c37edf320be8a2f5f688b4afce7c5a065d785bea8c95645d8b  LocalConfig.kmk
7855dba4f147d9387867a767c16191befee22253fa7705215822c6db9d5621fc  no-glibc.patch
0b2de9465eb2fb3731581c99332a962d299ea4137656ec1c0c46e0f026c415f1  dladdr1.patch"
sha512sums="eef01d1a5121905d2fbfcd48081f18db06433187bfbfea6a006b3adea11cad8c8351025fd19fa115c132231592330b17bfeba033a3a168f3064176a3f7586d7a  VirtualBox-5.0.12.tar.bz2
11cd536baed2d56405103f18a8318a202092755a74baf10730aa58dc57032e327697b1c7f76bf9bf438927093ba9ac467ffa0c4564c7f6b1d3b2b3936f34fa73  release-2.2.0.tar.gz
a126ef0182caca3fcbe5d12947cd63a6a729280127f5ead874b5ae0d1fe5f3aadd538b639bfd0d738f95048c25027761f47374e91b585b78e1d5a65ec98a5c23  LocalConfig.kmk
6bcb267bac65ea1d95bc5a520f2d68637008c68248a1f3a615bc25cc253dc3a1774c06c9b8e9e8df2a7756c83202c3352cdfcb3ac42be6916885759b9514ed27  no-glibc.patch
b9f54aac199574d26271acf87903fc34e5ede4d6119f82c5cd9ef2c6ff64301ffa6958f8c8068ba16a8fa684faa00419f8dff668b631edf9aa12d975337fdc8c  dladdr1.patch"
